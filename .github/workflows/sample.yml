name: PR Update Notification

on:
  schedule:
    - cron: "*/15 * * * *"  # Run every 15 minutes

  pull_request:
    types:
      - synchronize
      - update

jobs:
  send_notification:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Git
        uses: actions/checkout@v2
        
      - name: Install required libraries for TLS support
        run: sudo apt-get update && sudo apt-get install -y libnet-ssleay-perl libio-socket-ssl-perl

      - name: Install sendemail package
        run: sudo apt-get update && sudo apt-get install -y sendemail

      - name: Check for PR updates
        id: check_updates
        run: |
          # Fetch the list of closed pull requests
          closed_pull_requests=$(curl -s -H "Authorization: Bearer ${{ secrets.PR_TOKEN }}" \
                                "https://api.github.com/repos/working-sonata/integration-teams/pulls?state=closed")

          echo "$closed_pull_requests"
          
          # Read the last update timestamp from the file or set to a default value if it doesn't exist
          last_update_timestamp=$(cat last_update_timestamp.txt 2>/dev/null || echo "1970-01-01T00:00:00Z")
          echo "Closed Pull Requests: $closed_pull_requests"
          
          # Extract the PRs that were updated after the last timestamp
          updated_pull_requests=$(echo "$closed_pull_requests" | jq -r --arg last_timestamp "$last_update_timestamp" '.[] | select(.updated_at > $last_timestamp)')
          
          # If there are updated PRs, construct and send the email
          if [ -n "$updated_pull_requests" ]; then
            echo "Closed PR updated. Trigger email notification."
            
            pr_details=""
            for pr in $updated_pull_requests; do
              pr_number=$(echo "$pr" | jq -r '.number')
              pr_title=$(echo "$pr" | jq -r '.title')
              pr_author=$(echo "$pr" | jq -r '.user.login')
              pr_url=$(echo "$pr" | jq -r '.html_url')
              pr_details+="PR Number: $pr_number\nTitle: $pr_title\nAuthor: $pr_author\nURL: $pr_url\n\n"
            done

            
            # Send the email using sendemail with TLS
            email_subject="GitHub PR Update Notification"
            email_body="Closed Pull Requests were updated. Details:\n$pr_details"
            echo -e "Subject: $email_subject\n\n$email_body" \
            | sendemail -f c.bhavya@sonata-software.com -t c.bhavya@sonata-software.com -s outlook.office365.com -o tls=yes -xu c.bhavya@sonata-software.com -xp Varshu@456 -m
            
            # Save the current timestamp as the last update timestamp
            echo "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" > last_update_timestamp.txt
          else
            echo "No updates to closed PRs."
          fi
